<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta name="theme-color" content="#FFFFFF">
		<title>Slimer.io</title>
		<link href="https://fonts.googleapis.com/css?family=Ubuntu:400,700&display=swap" rel="stylesheet">
		<style>
		body {
			position: relative;
			margin: 0;
		}
		#view  {
			position: absolute;
			overflow: hidden;
			touch-action: none;
		}
		#map  {
			position: relative;
			background: white url("mygrid.png") top left /auto repeat;
		}
		#player, .food {
			position: absolute;
			border-radius: 100%;
			background: black;
			border-style: solid;
			transition: width 300ms, height 300ms;
		}
		#player {
			z-index: 100;
			text-align: center;
		}
		#player > span  {
			font-family: 'Ubuntu', sans-serif;
			font-weight: bold;
			font-size: 30px;
			color: white;
			cursor: default;
			text-shadow: -1px -1px black, 1px -1px black, 1px 1px black, -1px 1px black;
		}
		</style>
	</head>
	<body>
		<div id="view">
			<div id="map">
				<div id="player"><span></span></div>
			</div>
		</div>

		<script>

			let game = {
				foodSize: 12,
				borderWidth: 5,
				foodsPer100sqrpx: 0.7,
				score: 0,
				scoreEl: null,
				map: document.getElementById("map"),
				view: document.getElementById("view"),
				mouseX: 0,
				mouseY: 0,
			};

			let player = {
				diameter: 40,
				speed: 10,
				color: Math.floor(Math.random() * 361),
				el: document.getElementById("player"),
				x: 0,
				y: 0,
			};

			updateScreen = function()  {
				game.view.style.width = window.innerWidth + "px";
				game.view.style.height = window.innerHeight  + "px";
				game.map.style.width = window.innerWidth + "px";
				game.map.style.height = window.innerHeight  + "px";
			}


			updatePlayerSize = function(size)  {
				player.diameter = size;
				player.el.style.width = player.diameter + "px";
				player.el.style.height = player.diameter + "px";
				player.el.style.lineHeight = player.diameter + "px";
				player.speed = Math.sqrt(player.diameter) / player.diameter * 30;
				game.scoreEl.innerHTML = game.score = Math.floor(Math.pow(player.diameter / 2, 2) * Math.PI / 100);
			}


			checkFood = function()  {
				let foodsCollection = document.getElementsByClassName("food");
				let foods = Array();
				for (i = 0; i < foodsCollection.length; i++)	{
					foods[i] = foodsCollection[i];
				}
				foods = foods.filter(function(food) {
					let distanceX = player.x - food.offsetLeft + player.diameter / 2 - game.foodSize / 2;
					let distanceY = player.y - food.offsetTop + player.diameter / 2 - game.foodSize / 2;
					let distance = Math.sqrt(distanceX*distanceX + distanceY*distanceY);

					return distance < player.diameter / 2 + game.borderWidth;
				});
				foods.forEach(function(food) {
					updatePlayerSize(Math.sqrt(Math.pow(player.diameter, 2) + Math.pow(food.clientWidth, 2)));
					game.map.removeChild(food);
				});
			}


			addFood = function()  {
				if (document.getElementsByClassName("food").length > (game.map.clientWidth * game.map.clientHeight) / (100*100) * game.foodsPer100sqrpx) return false;

				let fColor = Math.floor(Math.random() * 361);
				let spawnX = Math.round(Math.random() * game.map.clientWidth) - game.foodSize / 2 - game.borderWidth;
				let spawnY = Math.round(Math.random() * game.map.clientHeight) - game.foodSize / 2 - game.borderWidth;
				let food = document.createElement("div");
				food.classList.add("food");
				food.style.borderWidth = game.borderWidth + "px";
				food.style.backgroundColor = "hsl("+fColor+", 100%, 50%)";
				food.style.borderColor = "hsl("+fColor+", 100%, 50%)";
				food.style.width = game.foodSize + "px";
				food.style.height = game.foodSize + "px";
				food.style.left = spawnX + "px";
				food.style.top = spawnY + "px";
				game.map.appendChild(food);
			}


			clearOutsideFood = function() {
				let foodsCollection = document.getElementsByClassName("food");
				let foods = Array();
				for (let i = 0; i < foodsCollection.length; i++)  {
					foods[i] = foodsCollection[i];
				}
				foods = foods.filter(food =>
					food.offsetLeft > game.map.clientWidth - game.foodSize / 2 - game.borderWidth ||
					food.offsetTop > game.map.clientHeight - game.foodSize / 2 - game.borderWidth);

				foods.forEach(function(food) {
					game.map.removeChild(food);
				});
			};


			updatePos = function() {
				let playerRect = player.el.getBoundingClientRect();
				let offsetX = game.mouseX - playerRect.left - playerRect.width / 2;
				let offsetY = game.mouseY - playerRect.top - playerRect.width / 2;
				let preDistance = Math.sqrt(offsetX*offsetX + offsetY*offsetY);
				let distance = preDistance < 100 ? 100 : preDistance;

				if (preDistance > 1)	{
					let speedX = player.speed * offsetX / distance;
					let speedY = player.speed * offsetY / distance;

					player.x += speedX;
					player.y += speedY;
				}

				player.el.style.left = player.x + "px";
				player.el.style.top = player.y + "px";

				checkFood();
			}


			document.addEventListener("mousemove", function(event) {
				game.mouseX = event.clientX;
				game.mouseY = event.clientY;
			});

			document.addEventListener("touchmove", function(event) {
				event.preventDefault();
				game.mouseX = event.touches[0].clientX;
				game.mouseY = event.touches[0].clientY;
			});
			document.addEventListener("touchstart", function(event) {
				event.preventDefault();
				game.mouseX = event.clientX;
				game.mouseY = event.clientY;
			});
			document.addEventListener("touchend", function(event) {
				event.preventDefault();
			});
			window.addEventListener("resize", function()  {
				clearOutsideFood();
				updateScreen();
			});


			//GAME START POINT INITIALIZATION


			updateScreen();

			player.diamPlusBorder = player.diameter + game.borderWidth * 2;
			game.scoreEl = player.el.firstChild;

			game.mouseX = game.view.clientWidth / 2;
			game.mouseY = game.view.clientHeight / 2;

			player.x = (game.map.clientWidth - player.diamPlusBorder) / 2;
			player.y = (game.map.clientHeight - player.diamPlusBorder) / 2;

			player.el.style.backgroundColor = "hsl("+player.color+", 100%, 50%)";
			player.el.style.borderWidth = game.borderWidth + "px";
			player.el.style.borderColor = "hsl("+player.color+", 100%, 40%)";
			player.el.style.left = player.x + "px";
			player.el.style.top = player.y + "px";

			updatePlayerSize(player.diameter);

			setInterval(updatePos, 15);
			setInterval(addFood, 400);
		</script>
	</body>
</html>
