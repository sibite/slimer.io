<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta name="theme-color" content="#FFFFFF">
		<title>Slimer.io</title>
		<link href="https://fonts.googleapis.com/css?family=Ubuntu:400,700&display=swap" rel="stylesheet">
		<style>
		body {
			position: relative;
			margin: 0;
		}
		#view  {
			position: absolute;
			overflow: hidden;
			touch-action: none;
		}
		#inner-view  {
			width: 100%;
			height: 100%;
		}
		#map  {
			position: relative;
			background: white url("mygrid.png") top left /auto repeat;]
		}
		#player, .food {
			position: absolute;
			border-radius: 100%;
			background: black;
			border-style: solid;
			transition: width 300ms, height 300ms;
		}
		#player {
			z-index: 100;
			text-align: center;
		}
		#player > span  {
			font-family: 'Ubuntu', sans-serif;
			font-weight: bold;
			font-size: 30px;
			color: white;
			cursor: default;
			text-shadow: 3px 3px rgba(0, 0, 0, 0.5);
		}
		</style>
	</head>
	<body>
		<div id="view">
			<div id="inner-view">
				<div id="map">
					<div id="player"><span></span></div>
				</div>
			</div>
		</div>

		<script>

			let game = {
				foodSize: 12,
				borderWidth: 5,
				foodsPer100sqrpx: 0.7,
				spawnFoodPerSec: 2.5,
				spawnPreFood: true,
				score: 0,
				scoreEl: null,
				map: document.getElementById("map"),
				view: document.getElementById("view"),
				innerView: document.getElementById("inner-view"),
				mapWidth: 1500,
				mapHeight: 1500,
				viewScale: 1,
				mouseX: 0,
				mouseY: 0,
			};

			let player = {
				diameter: 40,
				speed: 10,
				color: Math.floor(Math.random() * 361),
				el: document.getElementById("player"),
				x: 0,
				y: 0,
			};

			updateView = function()  {
				game.view.style.width = window.innerWidth + "px";
				game.view.style.height = window.innerHeight + "px";
			}


			updatePlayerSize = function(diameter)  {
				player.diameter = diameter;
				player.diamPlusBorder = diameter + game.borderWidth * 2;
				player.el.style.width = player.diameter + "px";
				player.el.style.height = player.diameter + "px";
				player.el.style.lineHeight = player.diameter + "px";
				player.speed = Math.pow(player.diameter, 10/17) / player.diameter * 25;
				game.scoreEl.innerHTML = game.score = Math.floor(Math.pow(player.diameter / 2, 2) * Math.PI / 100);
				let minSize = Math.min(window.innerWidth, window.innerHeight);
				let prevScale = game.viewScale;
				game.viewScale = Math.min(	3 / Math.pow(player.diameter, 10/40),			 minSize / player.diameter / 2);
				animateScale(prevScale);
			}


			checkFood = function()  {
				let foodsCollection = document.getElementsByClassName("food");
				let foods = Array();
				for (i = 0; i < foodsCollection.length; i++)	{
					foods[i] = foodsCollection[i];
				}
				foods = foods.filter(function(food) {
					let distanceX = player.x - food.offsetLeft + player.diameter / 2 - game.foodSize / 2;
					let distanceY = player.y - food.offsetTop + player.diameter / 2 - game.foodSize / 2;
					let distance = Math.sqrt(distanceX*distanceX + distanceY*distanceY);

					return distance < player.diameter / 2 + game.borderWidth;
				});
				foods.forEach(function(food) {
					updatePlayerSize(Math.sqrt(Math.pow(player.diameter, 2) + Math.pow(food.clientWidth, 2)));
					game.map.removeChild(food);
				});
			}


			addFood = function()  {
				if (document.getElementsByClassName("food").length > (game.map.clientWidth * game.map.clientHeight) / (100*100) * game.foodsPer100sqrpx) return false;

				let fColor = Math.floor(Math.random() * 361);
				let spawnX = Math.round(Math.random() * game.map.clientWidth) - game.foodSize / 2 - game.borderWidth;
				let spawnY = Math.round(Math.random() * game.map.clientHeight) - game.foodSize / 2 - game.borderWidth;
				let food = document.createElement("div");
				food.classList.add("food");
				food.style.borderWidth = game.borderWidth + "px";
				food.style.backgroundColor = "hsl("+fColor+", 100%, 50%)";
				food.style.borderColor = "hsl("+fColor+", 100%, 50%)";
				food.style.width = game.foodSize + "px";
				food.style.height = game.foodSize + "px";
				food.style.left = spawnX + "px";
				food.style.top = spawnY + "px";
				game.map.appendChild(food);
			}


			clearOutsideFood = function() {
				let foodsCollection = document.getElementsByClassName("food");
				let foods = Array();
				for (let i = 0; i < foodsCollection.length; i++)  {
					foods[i] = foodsCollection[i];
				}
				foods = foods.filter(food =>
					food.offsetLeft > game.map.clientWidth - game.foodSize / 2 - game.borderWidth ||
					food.offsetTop > game.map.clientHeight - game.foodSize / 2 - game.borderWidth);

				foods.forEach(function(food) {
					game.map.removeChild(food);
				});
			};

			animateScale = function(prevScale)  {
				let actualScale = prevScale;
				let time = 300;
				let frames = Math.floor(time / 15);
				let leftFrames = frames;
				if (frames > 0)	{
					let frame = function()  {
						if (leftFrames <= 0)
							clearInterval(iv);
						else  {
							actualScale = actualScale + (game.viewScale - actualScale) / leftFrames;
							game.innerView.style.transform = "scale("+actualScale+")";
							leftFrames--;
						}
					}
					let iv = setInterval(frame, 15);
				}
				else  {
					game.innerView.style.transform = "scale("+game.viewScale+")";
				}
			}

			updatePos = function() {

				//PLAYER MOVE

				let playerRect = player.el.getBoundingClientRect();
				let offsetX = game.mouseX - playerRect.left - playerRect.width / 2;
				let offsetY = game.mouseY - playerRect.top - playerRect.width / 2;
				let preDistance = Math.sqrt(offsetX*offsetX + offsetY*offsetY);
				let distance = preDistance < 100 ? 100 : preDistance;

				if (preDistance > 10)	{
					let speedX = player.speed * offsetX / distance;
					let speedY = player.speed * offsetY / distance;

					player.x += speedX;
					player.y += speedY;
				}

				//PREVENTING FROM MOVING OUTSIDE THE BORDERS

				let playerRealX = player.x + player.diamPlusBorder / 2;
				let playerRealY = player.y + player.diamPlusBorder / 2;

				player.x =
				playerRealX < 0 ? 0 - player.diamPlusBorder / 2 :
				playerRealX > game.mapWidth ? game.mapWidth - player.diamPlusBorder / 2 :
				player.x;

				player.y =
				playerRealY < 0 ? 0 - player.diamPlusBorder / 2 :
				playerRealY > game.mapHeight ? game.mapHeight - player.diamPlusBorder / 2 :
				player.y;



				player.el.style.left = player.x + "px";
				player.el.style.top = player.y + "px";

				checkFood();

				//VIEW MOVE

				game.map.style.left = game.view.offsetWidth / 2 - playerRealX + "px";
				game.map.style.top = game.view.offsetHeight / 2 - playerRealY + "px";
				updateView();
			}


			document.addEventListener("mousemove", function(event) {
				game.mouseX = event.clientX;
				game.mouseY = event.clientY;
			});

			document.addEventListener("touchmove", function(event) {
				event.preventDefault();
				game.mouseX = event.touches[0].clientX;
				game.mouseY = event.touches[0].clientY;
			});
			document.addEventListener("touchstart", function(event) {
				event.preventDefault();
				game.mouseX = event.clientX;
				game.mouseY = event.clientY;
			});
			document.addEventListener("touchend", function(event) {
				event.preventDefault();
			});
			window.addEventListener("resize", function()  {
				clearOutsideFood();
				updateScreen();
			});


			//GAME START POINT INITIALIZATION


			updateView();

			player.diamPlusBorder = player.diameter + game.borderWidth * 2;
			game.scoreEl = player.el.firstChild;

			game.mouseX = game.view.clientWidth / 2;
			game.mouseY = game.view.clientHeight / 2;

			game.map.style.width = game.mapWidth + "px";
			game.map.style.height = game.mapHeight + "px";

			player.x = (game.map.clientWidth - player.diamPlusBorder) / 2;
			player.y = (game.map.clientHeight - player.diamPlusBorder) / 2;

			player.el.style.backgroundColor = "hsl("+player.color+", 100%, 50%)";
			player.el.style.borderWidth = game.borderWidth + "px";
			player.el.style.borderColor = "hsl("+player.color+", 100%, 40%)";
			player.el.style.left = player.x + "px";
			player.el.style.top = player.y + "px";

			updatePlayerSize(player.diameter);

			if (game.spawnPreFood == true)	{
				for (let i = 0; i < (game.mapWidth * game.mapHeight) / (100*100) * game.foodsPer100sqrpx / 2; i++)	{
					addFood();
				}
			}

			setInterval(updatePos, 15);
			setInterval(addFood, 1000 / game.spawnFoodPerSec);
		</script>
	</body>
</html>
